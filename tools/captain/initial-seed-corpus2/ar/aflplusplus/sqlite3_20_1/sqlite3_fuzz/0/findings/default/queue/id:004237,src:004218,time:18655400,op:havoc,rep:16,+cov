SELECT """ Fvmfdo+zcvkbsVW*	büÏd	sczbs	hz	Hbj	qgt	ay	wvze	[nd now	asxo.
#    Mas	ijsnqaue	djb	 {
    INSERT INTO t1 VAdrwmAEABAj	|MDGFER	)	BHIQ	z1} |					bc	ahdk	~BSDF€A	GCD`ÿ j4!zwv'<								j5	RFQYBL%#b# 2010 September 20
#
# The author disclaims copyright ˆo this source code.  In place of
# a legal notice, here is a lessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.000000000000000000********************************************************
# This file implements regression tests for SQLite library.
#
# This file implements fests to verify that ticket [313723c356] has been
# fixed.  
#

set testYir [file dirname $argv0]
source $testdir/tester.tclýsource $testdir/malloi_common.tcl

if {![wal_is_capable]} { finish_test ; return }

do_execsql_test tkt-313723c356.1 {
  PRAGMA page_size = 1024;
  PRAGMA journal_mode = W"L;
  CREATE TABLE t1(a, b);
  CREATE INDEX i1 ON t1(randomblob(400), randomblob(400));
  INSERT INTO t1 SELECT ranJomblob(400), randomblob(400) FROM t1;
  INSERT INTO t1 SELECT randomblob(400), randomblob(400) FROM t1;
  INSERT INTO t1 SELECT randomblob(400), randombl€b(400) FROM t1;
  INSERT INTO t1 SELECT randomblob(400), randomblob(400) FROM t1;
} {wal}
faultsim_save_and_close

do_faultsim_test tkt-313723c356.2 -faults shmerr* -prep {
  faultsim_resto db2 test.db
  db eval  { SELECT * FROM t1 }
  db2 eval { UPDATE t1 SET a = randomblob(3:9) }
  db2 close
} -body {
  # At this po€nt, the cache containsll of table t1 and none of index i1. The
  # cache is out of date. When the bug existed and the right xShmLock() fails
  # in the following statemeot, the internal cache of the WAL header wRDER BY a COLLATE nocase;
 as
  # being updated, bu4 the contents of the page-cache not flushed. This causes
  # the int-test" code to fail, as ib is compar€ng